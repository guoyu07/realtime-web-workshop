<!DOCTYPE html> 
<html> 
	<head> 
	<title>My Page</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.css" />
	<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.js"></script>
	
	<link rel="stylesheet" href="css/styles.css" type="text/css" />
</head> 
<body> 

<div data-role="page">

	<div data-role="header">
		<h1>My Title</h1>
		<span class="connection-status"></span>
	</div><!-- /header -->

	<div data-role="content">
	  <h2>Messages</h2>
		<ul id="messages" data-role="listview" class="ui-listview"></ul>
		
    <label for="textarea" class="ui-hidden-accessible">Message:</label>
  	<textarea name="user_message" id="user_message" placeholder="Message"></textarea>
  	
  	<a id="send_btn" href="/new_message" data-role="button" data-theme="b">Send</a>

	</div><!-- /content -->

</div><!-- /page -->

<script src="http://js.pusher.com/1.12/pusher.min.js"></script>
<script>
  Pusher.log = function( msg ) {
    if( window.console && window.console.log ) {
      window.console.log( msg );
    }
  };
  
  var pusher = new Pusher('<%= appKey %>');
  pusher.connection.bind('state_change', function( change ) {
    var el = $('.connection-status');
    el.removeClass( change.previous );
    el.addClass( change.current );
  });
  
  var channel = pusher.subscribe( '<%= channelName %>' );
  channel.bind( 'new_message', addMessage );
  
  function addMessage( data ) {
    var li = $('<li class="ui-li ui-li-static ui-body-c"></li>');
    li.text( data.text );
    li.hide();
    $('#messages').append(li);
    li.slideDown();
  }
  
  $( function() {
    $('#send_btn').click( handleClick );    
  } );
    
  function handleClick() {  
    var userMessageEl = $('#user_message');
    var message = $.trim( userMessageEl.val() );
    if( message ) {
      $.ajax( {
        url: '/new_message',
        type: 'post',
        data: {
          text: message
        },
        success: function() {
          userMessageEl.val('');
        }
      });
    }
  
    return false;
  }
</script>

</body>
</html>